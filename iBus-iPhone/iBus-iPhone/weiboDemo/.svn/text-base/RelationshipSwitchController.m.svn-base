//
//  RelationshipController.m
//  weiboDemo
//
//  Created by yanghua on 3/25/13.
//  Copyright (c) 2013 yanghua. All rights reserved.
//

#import "RelationshipSwitchController.h"

#import "FollowedController.h"
#import "FollowerController.h"
#import "FindFriendController.h"

@interface RelationshipSwitchController ()

@property (nonatomic,retain) FollowedController *followedCtrller;
@property (nonatomic,retain) FollowerController *followerCtrller;

@property (nonatomic,retain) NSMutableDictionary *indexAndGroupIdDic;


@end

@implementation RelationshipSwitchController

- (void)dealloc{
    [_followedCtrller release],_followedCtrller=nil;
    [_followerCtrller release],_followerCtrller=nil;
    
    [super dealloc];
}

- (id)init{
    self=[super init];
    if (self) {
        _followedCtrller=[[FollowedController alloc] initWithRefreshHeaderViewEnabled:NO andLoadMoreFooterViewEnabled:NO andTableViewFrame:Default_TableView_Frame loadType:normal_load];
        [self addChildViewController:_followedCtrller];
        
        _followerCtrller=[[FollowerController alloc] initWithRefreshHeaderViewEnabled:NO andLoadMoreFooterViewEnabled:NO andTableViewFrame:Default_TableView_Frame];
        [self addChildViewController:_followerCtrller];
    }
    
    return self;
}

- (void)loadView{
    [self layoutSubViews];
}

- (void)viewDidLoad
{
    [super viewDidLoad];
    
    [self sendRequest4GetGroup];
    
    [self setRightBarButtonForNavigationBar];
}

- (void)didReceiveMemoryWarning
{
    [super didReceiveMemoryWarning];
}

#pragma mark - UI Generate
- (void)layoutSubViews{
    [super layoutSubViews];
    
    self.view=[[[UIView alloc] initWithFrame:CGRectMake(ZERO_Original_X, ZERO_Original_Y, MainWidth, MainHeight-300)] autorelease];
    self.view.backgroundColor=[UIColor whiteColor];
    
    [self.view addSubview:self.followedCtrller.view];
}

- (void)initNavigationBarItem:(NSMutableArray*)menuItems{
    if (self.navigationItem) {
        CGRect frame = CGRectMake(0.0, 0.0, 200.0, self.navigationController.navigationBar.bounds.size.height);
        SINavigationMenuView *navMenu = [[SINavigationMenuView alloc] initWithFrame:frame title:@"全部关注"];
        [navMenu displayMenuInView:self.view];
        navMenu.items = menuItems;
        navMenu.delegate = self;
        self.navigationItem.titleView = navMenu;
    }
}


-(void)setRightBarButtonForNavigationBar{
    UIButton *btn=[UIButton initButtonInstanceWithType:UIButtonTypeCustom
                                                 frame:CGRectMake(285,0,50,50)
                                               imgName:@"findFriend.png"
                                           eventTarget:self
                                           touchUpFunc:@selector(findFriend_touchUpInside:)
                                         touchDownFunc:nil];
    
	UIBarButtonItem *menuBtn=[[UIBarButtonItem alloc]initWithCustomView:btn];
	self.navigationItem.rightBarButtonItem=menuBtn;
	[menuBtn release];
}

- (void)findFriend_touchUpInside:(id)sender{
    FindFriendController *findFriendCtrller=[[[FindFriendController alloc] initWithRefreshHeaderViewEnabled:NO andLoadMoreFooterViewEnabled:NO andTableViewFrame:Findfriend_TableView_Frame] autorelease];
    [self.navigationController pushViewController:findFriendCtrller animated:YES];
}

#pragma mark - private methods -
- (void)sendRequest4GetGroup{
    NSURL *requestUrl=[NSURL URLWithString:[NSString stringWithFormat:Url_Group,
                                            Url_Base,Default_UserId]];
    __block ASIHTTPRequest *request=[ASIHTTPRequest requestWithURL:requestUrl];
    [request setCompletionBlock:^{
        NSData *responseData = [request responseData];
        
        NSDictionary *responseDic=[NSJSONSerialization JSONObjectWithData:responseData
                                                                  options:NSJSONReadingMutableContainers error:nil];
        
        //success
        if ([responseDic[@"statusCode"] intValue]==Status_Success) {
            NSMutableArray *menuItemArr=
                [self generateAllGroups:responseDic[@"data"][@"groups"] andTotalCount:[responseDic[@"data"][@"membersTotalCount"] longValue]];
            [self initNavigationBarItem:menuItemArr];
        }
        
    }];
    
    [request startAsynchronous];
}



- (NSMutableArray*)generateAllGroups:(NSArray*)responsedArr
                       andTotalCount:(long)count{
    NSMutableArray *resultArr=[NSMutableArray array];
    self.indexAndGroupIdDic=[NSMutableDictionary dictionary];
    
    [resultArr addObject:[NSString stringWithFormat:@"%@(%ld)",@"全部关注",count]];
    self.indexAndGroupIdDic[[NSNumber numberWithInt:0]]=@"-1";
    
    for (int i=1; i<=responsedArr.count; i++) {
        [resultArr addObject: [NSString stringWithFormat:@"%@(%@)",responsedArr[i-1][@"groupName"],responsedArr[i-1][@"membersCount"]]];
        self.indexAndGroupIdDic[[NSNumber numberWithInt:i]]=
                [NSString stringWithFormat:@"%ld",[responsedArr[i-1][@"groupId"] longValue]];
    }
    
    self.indexAndGroupIdDic[[NSNumber numberWithInt:responsedArr.count+1]]=@"-1";
    [resultArr addObject:@"粉丝"];
    
    return resultArr;
}

#pragma mark - SINavigationMenuDelegate -
- (void)didSelectItemAtIndex:(NSUInteger)index
{
    SINavigationMenuView *navMenu=(SINavigationMenuView*)self.navigationItem.titleView;
    if (navMenu) {
        navMenu.menuButton.title.text=navMenu.items[index];
    }
    
    NSMutableDictionary *notificationObj=[NSMutableDictionary dictionaryWithCapacity:2];
    
    if (index==0) {             //first item
        [self.followerCtrller.view removeFromSuperview];
        [self.view addSubview:self.followedCtrller.view];
        
        //load notification
        notificationObj[@"id"]=Default_UserId;
        notificationObj[@"type"]=[NSNumber numberWithInt:loadByUser];
    }else if(index==self.indexAndGroupIdDic.count-1){       //last item
        [self.followedCtrller.view removeFromSuperview];
        [self.view addSubview:self.followerCtrller.view];
    }else{
        NSString *groupId=self.indexAndGroupIdDic[[NSNumber numberWithInteger:index]];
        
        //switch to follower controller's view
        [self.followerCtrller.view removeFromSuperview];
        [self.view addSubview:self.followedCtrller.view];
        
        //load notification
        notificationObj[@"id"]=groupId;
        notificationObj[@"type"]=[NSNumber numberWithInt:loadByGroup];
    }
    
    //send a notification to notification center
    [[NSNotificationCenter defaultCenter]
     postNotificationName:Notification_For_ChangedGroup object:notificationObj];
    
    
    
//    switch (index) {
//        case 0:         //全部关注
//        {
//            [self.followerCtrller.view removeFromSuperview];
//            [self.view addSubview:self.followedCtrller.view];
//        }
//            break;
//            
//        case 5:         //模拟粉丝
//        {
//            [self.followedCtrller.view removeFromSuperview];
//            [self.view addSubview:self.followerCtrller.view];
//        }
//            break;
//            
//        default:
//            break;
//    }
}

#pragma mark - ASIHttpRequest Delegate -
- (void)request:(ASIHTTPRequest *)request
 didReceiveData:(NSData *)data{
    
    
    
}

@end
